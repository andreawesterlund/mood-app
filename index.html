<div class="options">
    <label>CYCLE? &nbsp; 
        <input type="radio" name="cycle" value="ovulation"> OVUL
        <input type="radio" name="cycle" value="menstruation"> MENS
        <button onclick="clearRadio('cycle')" style="font-size:0.7rem; margin-left:10px; border:none; background:#ddd; border-radius:5px;">clear</button>
    </label>
    <label>MOON? &nbsp; 
        <input type="radio" name="moon" value="full"> FULL
        <input type="radio" name="moon" value="new"> NEW
        <button onclick="clearRadio('moon')" style="font-size:0.7rem; margin-left:10px; border:none; background:#ddd; border-radius:5px;">clear</button>
    </label>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwIP_WxRUY_MeswIM2c1RJWvCqpIq3_9IWkd_vQGUwWoLO7mVFx7U1xsV9NN7eEUQRatA/exec";
    let chosenMood = "";

    function clearRadio(name) {
        document.querySelectorAll(`input[name="${name}"]`).forEach(rb => rb.checked = false);
    }

    function sel(m, btn) {
        chosenMood = m;
        document.querySelectorAll('.emoji-btn').forEach(b => b.classList.add('dim'));
        btn.classList.remove('dim');
    }

    async function save() {
        if(!chosenMood) return alert("Select a mood!");
        const data = {
            date: new Date().toLocaleDateString('en-CA'),
            mood: chosenMood,
            cycle: document.querySelector('input[name="cycle"]:checked')?.value || "None",
            moon: document.querySelector('input[name="moon"]:checked')?.value || "None"
        };
        document.getElementById('save-btn').innerText = "Saving...";
        // 'no-cors' is used for the POST to avoid preflight errors
        await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(data), mode: 'no-cors' });
        alert("Saved!");
        location.reload();
    }

    async function renderYear() {
        const grid = document.getElementById('grid');
        grid.innerHTML = "Loading...";
        try {
            // Fetching with redirect: 'follow' is key for Google Apps Script
            const res = await fetch(WEB_APP_URL, { redirect: 'follow' });
            const history = await res.json();
            grid.innerHTML = "";

            const year = 2026; 
            for (let m = 0; m < 12; m++) {
                let daysInMonth = new Date(year, m + 1, 0).getDate();
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    // We match the date string exactly
                    const entry = history.find(e => e.date === dateStr);
                    
                    const el = document.createElement('div');
                    el.className = 'day-box';
                    if (d === 1) el.classList.add('month-start');
                    
                    if (entry) {
                        el.innerText = entry.mood !== "None" ? entry.mood : "";
                        if (entry.cycle === 'menstruation') el.classList.add('frame-menstruation');
                        if (entry.cycle === 'ovulation') el.classList.add('frame-ovulation');
                        if (entry.moon === 'full') el.innerHTML += '<span class="moon-icon">●</span>';
                        if (entry.moon === 'new') el.innerHTML += '<span class="moon-icon">○</span>';
                        el.onclick = () => alert(`${new Date(dateStr).toDateString()}`);
                    }
                    grid.appendChild(el);
                }
            }
        } catch (e) { grid.innerHTML = "Error loading history."; }
    }

    function show(id) {
        document.getElementById('input-screen').style.display = id === 'input-screen' ? 'flex' : 'none';
        document.getElementById('year-screen').style.display = id === 'year-screen' ? 'block' : 'none';
        if(id === 'year-screen') renderYear();
    }
</script>
